<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gửi File Đơn Giản - Debug</title>
</head>
<body>
    <h2>Gửi File Qua Socket - Debug</h2>
    
    <div>
        <label for="senderID">ID người gửi:</label>
        <input type="text" id="senderID" value="41cf6b7a">
    </div>
    
    <div>
        <label for="receiverID">ID người nhận:</label>
        <input type="text" id="receiverID" value="75e9f681">
    </div>
    
    <div>
        <label for="fileInput">Chọn file:</label>
        <input type="file" id="fileInput">
        <div id="fileInfo"></div>
    </div>
    
    <button id="sendButton">Gửi File</button>
    
    <div id="status"></div>
    <div id="logs" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 200px; overflow: auto;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script>
        // Thêm các log để debug
        function log(message) {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${time}] ${message}`);
        }

        // Kết nối socket với các tùy chọn
        const socket = io('http://localhost:3000', {
            reconnection: false
        });
        
        // DOM Elements
        const senderIDInput = document.getElementById('senderID');
        const receiverIDInput = document.getElementById('receiverID');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const sendButton = document.getElementById('sendButton');
        const statusElement = document.getElementById('status');
        
        // Socket events
        socket.on('connect', () => {
            statusElement.textContent = 'Đã kết nối đến server. Socket ID: ' + socket.id;
            log('Đã kết nối với server. Socket ID: ' + socket.id);
        });
        
        socket.on('disconnect', (reason) => {
            statusElement.textContent = 'Đã ngắt kết nối: ' + reason;
            log('Đã ngắt kết nối: ' + reason);
        });
        
        socket.on('connect_error', (error) => {
            log('Lỗi kết nối: ' + error.message);
        });
        
        socket.on('error', (error) => {
            log('Lỗi socket: ' + error.message);
        });

        socket.on('serverRestart', (data) => {
            console.log('⚠️ Server đã restart:', data.message);
        });
        
        // Hiển thị thông tin file
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileInfo.textContent = `Tên file: ${file.name}, Kích thước: ${fileSizeMB} MB`;
                log(`Đã chọn file: ${file.name}, Kích thước: ${fileSizeMB} MB`);
            }
        });
        
        // Tạo ID ngẫu nhiên cho tin nhắn
        function generateMessageID() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Gửi tin nhắn
        sendButton.addEventListener('click', async () => {
            const senderID = senderIDInput.value;
            const receiverID = receiverIDInput.value;
            const file = fileInput.files[0];
            
            if (!senderID || !receiverID) {
                statusElement.textContent = 'Vui lòng nhập ID người gửi và người nhận.';
                return;
            }
            
            if (!file) {
                statusElement.textContent = 'Vui lòng chọn file để gửi.';
                return;
            }
            
            sendButton.disabled = true;
            statusElement.textContent = 'Đang chuẩn bị gửi file...';
            
            try {
                // Chuyển đổi file thành base64
                log('Bắt đầu chuyển file thành base64...');
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    log('Đã chuyển xong file thành base64');
                    
                    try {
                        let base64Data = e.target.result.split(',')[1];
                        
                        // Xác định loại tin nhắn
                        const getMessageTypeID = (file) => {
                            if (!file) return 'type1'; // Nếu không có file => tin nhắn text

                            if (file.type.startsWith('image/')) return 'type2'; // Ảnh
                            if (file.type.startsWith('video/')) return 'type3'; // Video

                            return 'type5'; // Các loại file khác (PDF, Word, Excel, ZIP, v.v.)
                        };

                        const messageTypeID = getMessageTypeID(file);
                        console.log(`Loại tin nhắn: ${messageTypeID}`);

                        
                        // Tạo dữ liệu tin nhắn
                        const messageID = generateMessageID();
                        const message = {
                            senderID: senderID,
                            receiverID: receiverID,
                            
                            messageTypeID: messageTypeID,
                            context: file.name,
                            messageID: messageID,
                            file: {
                                name: file.name,
                                type: file.type,
                                data: base64Data
                            }
                        };
                        
                        // Log trước khi gửi
                        console.log(`Gửi tin nhắn: ${JSON.stringify(message, null, 2)}`);

                        
                        // Gửi tin nhắn
                        statusElement.textContent = 'Đang gửi file...';
                        socket.emit('sendMessage', message)
                    } catch (error) {
                        log('Lỗi khi xử lý dữ liệu: ' + error.message);
                        statusElement.textContent = 'Lỗi: ' + error.message;
                        sendButton.disabled = false;
                    }
                };
                
                reader.onerror = function(error) {
                    log('Lỗi khi đọc file: ' + error);
                    statusElement.textContent = 'Lỗi khi đọc file';
                    sendButton.disabled = false;
                };
                
                // Bắt đầu đọc file
                reader.readAsDataURL(file);
                
            } catch (error) {
                log('Lỗi: ' + error.message);
                statusElement.textContent = 'Lỗi: ' + error.message;
                sendButton.disabled = false;
            }
        });
    </script>
</body>
</html>